{% extends "core/base.html" %}
{% load timezone_filters %}

{% block title %}Attendance Report - {{ selected_date }}{% endblock %}

{% block content %}
<div class="card">
    <h2>üìÖ Daily Attendance Report</h2>
    
    <form method="get" class="filter-form">
        <div>
            <label for="date">Date:</label>
            <input type="date" id="date" name="date" value="{{ selected_date|date:'Y-m-d' }}" required>
        </div>
        
        <div>
            <label for="device">Device:</label>
            <select id="device" name="device">
                <option value="">All Devices</option>
                {% for device in devices %}
                    <option value="{{ device.id }}" {% if selected_device_id == device.id|stringformat:"s" %}selected{% endif %}>
                        {{ device.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <input type="text" id="search" name="search" value="{{ search_query }}" placeholder="üîç Search by ID or Name..." onkeyup="searchAttendance()" style="padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 4px; width: 300px;">
        
        <button type="submit" class="btn btn-primary">Filter</button>
        
        <button type="button" class="btn btn-success" onclick="syncDay()">üîÑ Sync This Day</button>
        
        <button type="button" class="btn btn-secondary" onclick="reprocessDay()">üîÅ Recalculate Flags</button>
        
        <a href="{% url 'attendance_print' %}?date={{ selected_date|date:'Y-m-d' }}{% if selected_device_id %}&device={{ selected_device_id }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" 
           target="_blank" class="btn btn-secondary">üñ®Ô∏è Print Report</a>
        
        <a href="{% url 'outliers_list' %}" class="btn btn-secondary">‚ö†Ô∏è View Outliers</a>
        
        <div class="pagination" style="margin-left: auto;">
            <a href="?date={{ prev_date|date:'Y-m-d' }}{% if selected_device_id %}&device={{ selected_device_id }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" class="btn btn-secondary">‚Üê Previous</a>
            <a href="?date={{ next_date|date:'Y-m-d' }}{% if selected_device_id %}&device={{ selected_device_id }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" class="btn btn-secondary">Next ‚Üí</a>
            <a href="?date={{ today|date:'Y-m-d' }}{% if selected_device_id %}&device={{ selected_device_id }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" class="btn btn-primary">Today</a>
        </div>
    </form>
</div>

<!-- Statistics -->
<div class="stats">
    <div class="stat-box">
        <div class="stat-label">Total Users</div>
        <div class="stat-value">{{ statistics.total_users }}</div>
    </div>
    
    <div class="stat-box">
        <div class="stat-label">Present</div>
        <div class="stat-value">{{ statistics.total_records }}</div>
    </div>
    
    <div class="stat-box" style="background: #ecf0f1; border-left: 4px solid #95a5a6;">
        <div class="stat-label">Absent</div>
        <div class="stat-value" style="color: #7f8c8d;">{{ statistics.absent_count }}</div>
    </div>
    
    <div class="stat-box success">
        <div class="stat-label">Normal Attendance</div>
        <div class="stat-value">{{ statistics.normal_count }}</div>
    </div>
    
    <div class="stat-box" style="background: #fff3e0; border-left: 4px solid #ff9800;">
        <div class="stat-label">Late Arrivals</div>
        <div class="stat-value" style="color: #ff9800;">{{ statistics.late_arrivals }}</div>
    </div>
    
    <div class="stat-box" style="background: #ffebee; border-left: 4px solid #f44336;">
        <div class="stat-label">Left Early</div>
        <div class="stat-value" style="color: #f44336;">{{ statistics.early_departures }}</div>
    </div>
    
    <div class="stat-box" style="background: #e3f2fd; border-left: 4px solid #2196f3;">
        <div class="stat-label">Incomplete</div>
        <div class="stat-value" style="color: #2196f3;">{{ statistics.incomplete_count }}</div>
    </div>
    
    <div class="stat-box warning" style="cursor: pointer;" onclick="window.location.href='{% url 'outliers_list' %}'">
        <div class="stat-label">Outliers (Separate Table)</div>
        <div class="stat-value">{{ statistics.outliers_count }}</div>
        <small style="opacity: 0.8;">Click to view ‚Üí</small>
    </div>
    
    <div class="stat-box {% if statistics.unsynced_count > 0 %}danger{% else %}success{% endif %}">
        <div class="stat-label">Unsynced to CRM</div>
        <div class="stat-value">{{ statistics.unsynced_count }}</div>
    </div>
</div>

<!-- Attendance Table -->
<div class="card">
    <h2>Attendance Records for {{ selected_date|date:"F d, Y" }}</h2>
    
    {% if attendances %}
    <table>
        <thead>
            <tr>
                <th>User Name</th>
                <th>Device</th>
                <th>Clock In</th>
                <th>Clock Out</th>
                <th>Hours</th>
                <th>Status</th>
                <th>Synced</th>
                <th>Notes</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for attendance in attendances %}
            <tr>
                <td><strong>{{ attendance.user_name_display }}</strong></td>
                <td>{{ attendance.device.name }}</td>
                <td>
                    {% if attendance.clock_in %}
                        {{ attendance.clock_in|format_datetime }}
                    {% else %}
                        <span class="badge badge-warning">N/A</span>
                    {% endif %}
                </td>
                <td>
                    {% if attendance.clock_out %}
                        {{ attendance.clock_out|format_datetime }}
                    {% else %}
                        <span class="badge badge-warning">N/A</span>
                    {% endif %}
                </td>
                <td>
                    {% if attendance.hours_worked %}
                        {{ attendance.hours_worked|floatformat:2 }}h
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if not attendance.attendance %}
                        <span class="badge" style="background: #95a5a6; color: white;">üö´ Absent</span>
                    {% else %}
                        {% if attendance.is_incomplete %}
                            <span class="badge" style="background: #2196f3; color: white;">üìã Incomplete</span>
                        {% endif %}
                        {% if attendance.is_late_arrival %}
                            <span class="badge" style="background: #ff9800; color: white;">‚è∞ Late Arrival</span>
                        {% endif %}
                        {% if attendance.is_early_departure %}
                            <span class="badge" style="background: #f44336; color: white;">‚è±Ô∏è Left Early</span>
                        {% endif %}
                        {% if attendance.is_outlier %}
                            <span class="badge" style="background: #ffc107; color: #333;">‚ö†Ô∏è Outlier</span>
                        {% endif %}
                        {% if not attendance.is_incomplete and not attendance.is_late_arrival and not attendance.is_early_departure and not attendance.is_outlier %}
                            <span class="badge badge-success">‚úì Normal</span>
                        {% endif %}
                    {% endif %}
                </td>
                <td>
                    {% if attendance.attendance %}
                        {% if attendance.synced_to_crm %}
                            <span class="badge badge-success">‚úì Synced</span>
                        {% else %}
                            <span class="badge badge-warning">Pending</span>
                        {% endif %}
                    {% else %}
                        <span class="badge" style="background: #ecf0f1; color: #7f8c8d;">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if attendance.outlier_reason %}
                        <small style="color: #e74c3c;">{{ attendance.outlier_reason }}</small>
                    {% endif %}
                </td>
                <td>
                    {% if attendance.id %}
                        <button class="btn btn-danger" onclick="deleteProcessed({{ attendance.id }})">Delete</button>
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; padding: 2rem; color: #7f8c8d;">
        No attendance records found for {{ selected_date|date:"F d, Y" }}.
    </p>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Auto-submit form when date or device changes
    document.getElementById('date').addEventListener('change', function() {
        this.form.submit();
    });
    
    document.getElementById('device').addEventListener('change', function() {
        this.form.submit();
    });
    
    // Sync day function
    async function syncDay() {
        const date = document.getElementById('date').value;
        const deviceId = document.getElementById('device').value;
        const syncBtn = event.target;
        
        if (!date) {
            alert('Please select a date');
            return;
        }
        
        // Disable button and show loading state
        syncBtn.disabled = true;
        syncBtn.textContent = '‚è≥ Syncing...';
        
        // Prepare form data
        const formData = new FormData();
        formData.append('date', date);
        if (deviceId) {
            formData.append('device', deviceId);
        }
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         getCookie('csrftoken');
        
        // Send sync request
        try {
            const response = await fetch('/sync-day/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                },
                body: formData
            });
            
            const data = await parseJsonResponse(response);
            
            syncBtn.disabled = false;
            syncBtn.textContent = 'üîÑ Sync This Day';
            
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                // Show success message
                let message = `Sync complete for ${data.date}:\n\n`;
                message += `Total Raw Records Fetched: ${data.total_raw_fetched}\n`;
                message += `Total Processed: ${data.total_processed}\n`;
                message += `Total Outliers Found: ${data.total_outliers}`;
                if (data.new_outliers > 0) {
                    message += ` (${data.new_outliers} new)\n\n`;
                } else {
                    message += `\n\n`;
                }
                
                if (data.processing_error) {
                    message += `Processing Error: ${data.processing_error}\n\n`;
                }
                
                message += 'Devices:\n';
                data.devices.forEach(device => {
                    message += `\n${device.name}:\n`;
                    message += `  - Fetched: ${device.raw_fetched} new records\n`;
                    if (device.error) {
                        message += `  - Note: ${device.error}\n`;
                    }
                });
                
                alert(message);
                
                // Reload the page to show updated data
                location.reload();
            }
        } catch (error) {
            syncBtn.disabled = false;
            syncBtn.textContent = 'üîÑ Sync This Day';
            alert('Error syncing: ' + error.message);
        }
    }
    
    // Reprocess day function
    async function reprocessDay() {
        const date = document.getElementById('date').value;
        const deviceId = document.getElementById('device').value;
        const btn = event.target;
        
        if (!date) {
            alert('Please select a date');
            return;
        }
        
        if (!confirm(`Recalculate late/early/outlier flags for ${date}? This will update existing records based on current settings.`)) {
            return;
        }
        
        btn.disabled = true;
        btn.textContent = '‚è≥ Processing...';
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
        
        try {
            const response = await fetch('/attendance/reprocess/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    start_date: date,
                    end_date: date,
                    device_id: deviceId || null
                })
            });
            
            const data = await parseJsonResponse(response);
            
            btn.disabled = false;
            btn.textContent = 'üîÅ Recalculate Flags';
            
            if (data.success) {
                alert(`Successfully reprocessed ${data.processed} attendance records for ${data.date_range}`);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            btn.disabled = false;
            btn.textContent = 'üîÅ Recalculate Flags';
            alert('Error reprocessing: ' + error.message);
        }
    }
    
    // Helper function to get CSRF cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    async function deleteProcessed(processedId) {
        if (!confirm('Delete this attendance (will remove the underlying raw punch(s) from the bridge DB)? This CANNOT delete single records on the device.')) {
            return;
        }

        const formData = new FormData();
        formData.append('processed_id', processedId);

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');

        try {
            const response = await fetch('{% url "delete_attendance" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            });
            
            const data = await parseJsonResponse(response);
            
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                alert('Deleted ' + data.deleted + ' raw record(s).');
                location.reload();
            }
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }
    
    function searchAttendance() {
        const input = document.getElementById('search');
        const filter = input.value.toLowerCase();
        const table = document.querySelector('table tbody');
        const rows = table.getElementsByTagName('tr');
        
        let visibleCount = 0;
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const userId = row.cells[0].textContent.toLowerCase();
            const userName = row.cells[1].textContent.toLowerCase();
            
            if (userId.includes(filter) || userName.includes(filter)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        }
    }
</script>
{% endblock %}

{% extends "core/base.html" %}
{% load timezone_filters %}

{% block title %}Dashboard - ZKTeco F18 Attendance Bridge{% endblock %}

{% block content %}
<div class="card">
    <h2>üìä Dashboard Overview</h2>
</div>

<!-- Today's Statistics -->
<div class="stats">
    <div class="stat-box">
        <div class="stat-label">Today's Attendance</div>
        <div class="stat-value">{{ today_stats.total }}</div>
    </div>
    
    <div class="stat-box warning">
        <div class="stat-label">Today's Outliers</div>
        <div class="stat-value">{{ today_stats.outliers }}</div>
    </div>
    
    <div class="stat-box {% if today_stats.unsynced > 0 %}danger{% else %}success{% endif %}">
        <div class="stat-label">Unsynced Records</div>
        <div class="stat-value">{{ today_stats.unsynced }}</div>
    </div>
    
    <div class="stat-box">
        <div class="stat-label">Active Devices</div>
        <div class="stat-value">{{ devices.count }}</div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card">
    <h2>Quick Actions</h2>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
        <a href="{% url 'attendance_report' %}" class="btn btn-primary">View Today's Report</a>
        <a href="/admin/core/processedattendance/" class="btn btn-secondary">Manage Records</a>
        <a href="/admin/core/device/" class="btn btn-secondary">Manage Devices</a>
        <a href="/api/" class="btn btn-secondary">API Documentation</a>
    </div>
</div>

<!-- Devices -->
<div class="card">
    <h2>üîå Registered Devices</h2>
    
    {% if devices %}
    <table>
        <thead>
            <tr>
                <th>Device Name</th>
                <th>IP Address</th>
                <th>Port</th>
                <th>Status</th>
                <th>Last Sync</th>
            </tr>
        </thead>
        <tbody>
            {% for device in devices %}
            <tr>
                <td><strong>{{ device.name }}</strong></td>
                <td>{{ device.ip_address }}</td>
                <td>{{ device.port }}</td>
                <td>
                    {% if device.enabled %}
                        <span class="badge badge-success">Enabled</span>
                    {% else %}
                        <span class="badge badge-danger">Disabled</span>
                    {% endif %}
                </td>
                <td>
                    {% if device.last_sync %}
                        {{ device.last_sync|format_datetime }}
                    {% else %}
                        <span class="badge badge-warning">Never</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; padding: 2rem; color: #7f8c8d;">
        No devices registered yet. Add devices in the <a href="/admin/core/device/">admin panel</a>.
    </p>
    {% endif %}
</div>

<!-- Raw Attendance Records -->
<div class="card">
    <h2>üìã Raw Attendance Records</h2>
    
    <form method="get" class="filter-form" style="margin-bottom: 1rem;">
        <div>
            <label for="date">Date:</label>
            <input type="date" id="date" name="date" value="{{ selected_date|date:'Y-m-d' }}" required>
        </div>
        
        <div>
            <input type="text" id="employee" name="employee" value="{{ employee_filter }}" placeholder="üîç Filter by Employee ID or Name..." style="padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 4px; width: 300px;">
        </div>
        
        <button type="submit" class="btn btn-primary">Filter</button>
        
        <div class="pagination" style="margin-left: auto;">
            <a href="?date={{ prev_date|date:'Y-m-d' }}{% if employee_filter %}&employee={{ employee_filter }}{% endif %}" class="btn btn-secondary">‚Üê Previous</a>
            <a href="?date={{ next_date|date:'Y-m-d' }}{% if employee_filter %}&employee={{ employee_filter }}{% endif %}" class="btn btn-secondary">Next ‚Üí</a>
            <a href="?date={{ today|date:'Y-m-d' }}{% if employee_filter %}&employee={{ employee_filter }}{% endif %}" class="btn btn-primary">Today</a>
        </div>
    </form>
    
    {% if page_obj %}
    <p style="color: #7f8c8d; margin-bottom: 1rem;">
        Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} records for {{ selected_date|date:"F d, Y" }}
    </p>
    
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Employee Name</th>
                <th>Device</th>
                <th>Status</th>
                <th>Verify Type</th>
            </tr>
        </thead>
        <tbody>
            {% for attendance in page_obj %}
            <tr>
                <td><strong>{{ attendance.timestamp|format_datetime }}</strong></td>
                <td>{{ attendance.user_name_display }}</td>
                <td>{{ attendance.device.name }}</td>
                <td>
                    {% if attendance.status == 0 %}
                        <span class="badge badge-success">Check In</span>
                    {% elif attendance.status == 1 %}
                        <span class="badge" style="background: #e74c3c; color: white;">Check Out</span>
                    {% else %}
                        <span class="badge" style="background: #95a5a6; color: white;">Status {{ attendance.status }}</span>
                    {% endif %}
                </td>
                <td>
                    <small style="color: #7f8c8d;">Type {{ attendance.verify_type }}</small>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="pagination" style="margin-top: 1rem; display: flex; justify-content: center; gap: 0.5rem;">
        {% if page_obj.has_previous %}
            <a href="?date={{ selected_date|date:'Y-m-d' }}&page=1{% if employee_filter %}&employee={{ employee_filter }}{% endif %}" class="btn btn-secondary">First</a>
            <a href="?date={{ selected_date|date:'Y-m-d' }}&page={{ page_obj.previous_page_number }}{% if employee_filter %}&employee={{ employee_filter }}{% endif %}" class="btn btn-secondary">Previous</a>
        {% endif %}
        
        <span class="btn" style="background: #ecf0f1; cursor: default;">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        
        {% if page_obj.has_next %}
            <a href="?date={{ selected_date|date:'Y-m-d' }}&page={{ page_obj.next_page_number }}{% if employee_filter %}&employee={{ employee_filter }}{% endif %}" class="btn btn-secondary">Next</a>
            <a href="?date={{ selected_date|date:'Y-m-d' }}&page={{ page_obj.paginator.num_pages }}{% if employee_filter %}&employee={{ employee_filter }}{% endif %}" class="btn btn-secondary">Last</a>
        {% endif %}
    </div>
    {% endif %}
    {% else %}
    <p style="text-align: center; padding: 2rem; color: #7f8c8d;">
        No attendance records found for {{ selected_date|date:"F d, Y" }}.
    </p>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Auto-submit form when date changes
    document.getElementById('date').addEventListener('change', function() {
        this.form.submit();
    });
</script>
{% endblock %}
